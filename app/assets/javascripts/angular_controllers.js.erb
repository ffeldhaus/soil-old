'use strict';

/* Controllers */

function AdminCtrl($scope, $resource, $log, $location) {
    var Games = $resource('/games/:game_id', {game_id: '@id'});
    var Supervisors = $resource('/supervisors/:supervisor_id', {supervisor_id: '@id'});

    $scope.games = Games.query();
    $scope.supervisors = Supervisors.query();

    $scope.getSupervisor = function (id) {
        return Supervisors.get({supervisor_id: id})
    };

    $scope.show = function () {
        return ($location.search()).show;
    };

    $scope.supervisor = {};
    $scope.supervisor.first_name = '';
    $scope.supervisor.last_name = '';
    $scope.supervisor.email = '';

    $scope.createSupervisor = function (supervisor) {
        Supervisors.save(supervisor);
        $scope.supervisors = Supervisors.query();
    };

    $scope.deleteSupervisor = function (supervisor) {
        Supervisors.delete({supervisor_id: supervisor.id});
        $scope.supervisors = Supervisors.query();
    };
}

AdminCtrl.$inject = ['$scope', '$resource', '$log', '$location'];

function GamesCtrl($scope, $resource, $log, $location) {
    var Games = $resource('/games/:game_id', {game_id: '@id'});
    $scope.games = Games.query();
    $scope.game = {};
    $scope.game.name = '';
    $scope.game.supervisor_id = null;

    function Player() {
        this.name = '';
        this.password = Math.random().toString(36).slice(-8);
    }

    $scope.game.players = [new Player(), new Player(), new Player(), new Player()];

    $scope.setPlayerSize = function (size) {
        if ($scope.game.players.length < size) {
            $scope.game.players.push(new Player(size));
        }
        else if ($scope.game.players.length > size) {
            $scope.game.players.pop();
        }
    }

    $scope.createGame = function (game) {
        Games.save(game);
        $scope.games = Games.query();
    };

    $scope.deleteGame = function (game) {
        Games.delete({game_id: game.id});
        $scope.games = Games.query();
    };

}

GamesCtrl.$inject = ['$scope', '$resource', '$log', '$location'];

function SoilCtrl($scope, $rootScope, $dialog, $resource, $log, $filter, $q, checkForNewRounds) {

    $rootScope.image_path = {
        'Brachland': '<%= asset_path('brachland.jpg') %>',
        'Ackerbohne': '<%= asset_path('ackerbohne.jpg') %>',
        'Gerste': '<%= asset_path('gerste.jpg') %>',
        'Hafer': '<%= asset_path('hafer.jpg') %>',
        'Kartoffel': '<%= asset_path('kartoffel.jpg') %>',
        'Mais': '<%= asset_path('mais.jpg') %>',
        'Roggen': '<%= asset_path('roggen.jpg') %>',
        'Tiere': '<%= asset_path('tiere.jpg') %>',
        'Weizen': '<%= asset_path('weizen.jpg') %>',
        'Zuckerruebe': '<%= asset_path('zuckerruebe.jpg') %>',
        'fertilizer': '<%= asset_path('fertilizer.png') %>',
        'pesticide': '<%= asset_path('pesticide.jpg') %>',
        'Überschwemmung': '<%= asset_path('flood.jpg') %>',
        'Dürre': '<%= asset_path('drought.jpg') %>',
        'Kälte': '<%= asset_path('cold.jpg') %>',
        'Blattlaus': '<%= asset_path('blattlaus.jpg') %>',
        'Kartoffelkäfer': '<%= asset_path('kartoffelkaefer.jpg') %>',
        'Maiszünsler': '<%= asset_path('maiszuensler.jpg') %>',
        'Drahtwurm': '<%= asset_path('drahtwurm.jpg') %>',
        'Fritfliege': '<%= asset_path('fritfliege.jpg') %>'
    };

    $rootScope.color_mapping = {
        'schlecht': '#FF0000',
        'ok': '#F5ED00',
        'gut': '#00FF00'
    };

    $rootScope.round_zero =
    <%= RoundSerializer.new(Round.new(:number => 0)).to_json %>.
    round;

    var Games = $resource('/games/:game_id', {game_id: '@id'});

    $scope.initialize = function (game_id, player_id) {
        $scope.selectedRound = 1;
        $scope.game_id = game_id;
        $scope.player_id = player_id;
        $scope.getGame(game_id, player_id);
    };

    $scope.getButtonText = function () {
        if ($scope.round.submitted) {
            return 'Auf andere Gruppen warten ...'
        } else if ($scope.gameOver) {
            return 'Ende des Spiels!'
        }
        else {
            return  'Runde abschicken »'
        }
    };

    $scope.getGame = function () {
        var deferred = $q.defer;
        $log.debug("Getting game with id: " + $scope.game_id);
        Games.get({game_id: $scope.game_id}, function (response) {
            $scope.game = response;
            $scope.player = $scope.game.players.filter(function (player) {
                return player.id == $scope.player_id;
            })[0];
            $scope.rounds = $filter('orderBy')($scope.player.rounds, 'number');
            $scope.round = $scope.rounds[$scope.rounds.length - 1];
            $scope.selectedRound = $scope.player.rounds.length;
            if ($scope.round.number < 11) {
                if (typeof $scope.checkForNewRounds === 'undefined') {
                    $scope.checkForNewRounds = checkForNewRounds;
                    $scope.checkForNewRounds.setScope($scope);
                    $scope.checkForNewRounds.query();
                } else {
                    $scope.startNewRound();
                }
            } else {
                $scope.endGame();
                $scope.gameOver = true;
            }
        });
    };

    $scope.showParcelInformation = function (parcel) {
        var opts = {
            backdrop: true,
            dialogFade: true,
            keyboard: true,
            backdropClick: true,
            templateUrl: "<%= asset_path('showParcelInformation.html') %>",
            controller: 'ShowParcelInformationCtrl',
            resolve: {
                game: function () {
                    return angular.copy($scope.game);
                },
                player: function () {
                    return angular.copy($scope.player);
                },
                round: function () {
                    return angular.copy($scope.rounds[$scope.selectedRound - 1]);
                },
                parcel: function () {
                    return angular.copy(parcel);
                },
                show: function () {
                    return angular.copy($scope.show);
                }
            }
        };

        var dialog = $dialog.dialog(opts);
        if ($scope.selectedRound > 1) {
            if ((parcel.plantation != 'Brachland' && parcel.plantation != 'Tiere') || ($scope.show == 'cropsequence' && parcel.plantation == 'Brachland')) {
                dialog.open();
            }
        }
    };

    $scope.startNewRound = function () {
        var opts = {
            backdrop: true,
            dialogFade: true,
            keyboard: true,
            backdropClick: true,
            templateUrl: "<%= asset_path('newRound.html') %>",
            controller: 'NewRoundCtrl',
            resolve: {
                round: function () {
                    return angular.copy($scope.round);
                },
                game: function () {
                    return angular.copy($scope.game);
                },
                player: function () {
                    return angular.copy($scope.player);
                }
            }
        };

        var dialog = $dialog.dialog(opts);
        dialog.open();
    };

    $scope.endGame = function () {
        var opts = {
            backdrop: true,
            dialogFade: true,
            keyboard: true,
            backdropClick: true,
            templateUrl: "<%= asset_path('endGame.html') %>",
            controller: 'EndGameCtrl',
            resolve: {
                round: function () {
                    return angular.copy($scope.round);
                },
                game: function () {
                    return angular.copy($scope.game);
                },
                player: function () {
                    return angular.copy($scope.player);
                }
            }
        };

        var dialog = $dialog.dialog(opts);

        dialog.open();
    };

    $scope.endRound = function () {
        var opts = {
            backdrop: true,
            dialogFade: true,
            keyboard: true,
            backdropClick: true,
            templateUrl: "<%= asset_path('endRound.html') %>",
            controller: 'EndRoundCtrl',
            resolve: {
                round: function () {
                    return angular.copy($scope.round);
                },
                game: function () {
                    return angular.copy($scope.game);
                },
                player: function () {
                    return angular.copy($scope.player);
                }
            }
        };

        var dialog = $dialog.dialog(opts);

        if ($scope.selectedRound == $scope.player.rounds.length && !$scope.gameOver && !$scope.round.submitted) {
            dialog.open().then(function (submitted) {
                if (submitted) {
                    $scope.round.submitted = true;
                }
            });
        }
    }
}

SoilCtrl.$inject = ['$scope', '$rootScope', '$dialog', '$resource', '$log', '$filter', '$q', 'checkForNewRounds'];

// the dialog is injected in the specified controller
function SelectPlantationCtrl($scope, $log, dialog) {
    $scope.plantations = [
        'Ackerbohne', 'Gerste', 'Hafer', 'Kartoffel', 'Mais', 'Roggen', 'Weizen', 'Zuckerruebe', 'Tiere', 'Brachland'
    ];

    $scope.click = function (plantation) {
        dialog.close(plantation);
    }

    $scope.close = function () {
        dialog.close();
    }
}

SelectPlantationCtrl.$inject = ['$scope', '$log', 'dialog'];

// the dialog is injected in the specified controller
function EndRoundCtrl($scope, $resource, dialog, game, player, round) {

    $scope.percentages = ['0%', '10%', '20%', '30%', '40%', '50%'];
    $scope.round = round;
    $scope.round.decision.machines = "0%";
    $scope.close = function (submitted) {
        dialog.close(submitted);
    };

    $scope.submitRound = function () {
        var Rounds = $resource('/games/:game_id/players/:player_id/rounds/:round_id', {game_id: game.id, player_id: player.id, round_id: round.id}, { update: { method: 'PUT' } });
        Rounds.update($scope.round);
        $scope.close(true);
    }
}

EndRoundCtrl.$inject = ['$scope', '$resource', 'dialog', 'game', 'player', 'round'];

function NewRoundCtrl($scope, dialog, round) {
    $scope.round = round;
    $scope.close = function () {
        dialog.close();
    };
}

NewRoundCtrl.$inject = ['$scope', 'dialog', 'round'];

function EndGameCtrl($scope, dialog, round) {
    $scope.round = round;
    $scope.close = function () {
        dialog.close();
    };
}

EndGameCtrl.$inject = ['$scope', 'dialog', 'round'];


function ShowParcelInformationCtrl($scope, $filter, dialog, game, player, round, parcel, show) {
    $scope.game = game;
    $scope.player = player;
    $scope.round = round;
    $scope.parcel = parcel;
    if (player.rounds[round.number - 2] !== undefined) {
        $scope.previous_round = player.rounds[round.number - 2];
        $scope.previous_round.field.parcels = $filter('orderBy')($scope.previous_round.field.parcels, 'number');
        $scope.previous_parcel = $scope.previous_round.field.parcels[parcel.number];
        if (player.rounds[round.number - 3] !== undefined) {
            $scope.preprevious_round = player.rounds[round.number - 3];
        } else {
            $scope.preprevious_round = $scope.round_zero;
        }

        $scope.preprevious_round.field.parcels = $filter('orderBy')($scope.preprevious_round.field.parcels, 'number');
        $scope.preprevious_parcel = $scope.preprevious_round.field.parcels[parcel.number];
    }
    $scope.animals = $scope.previous_round.field.parcels.filter(function (x) {
        return x.plantation == 'Tiere'
    }).length;
    $scope.show = show;
    $scope.close = function () {
        dialog.close();
    };
}

ShowParcelInformationCtrl.$inject = ['$scope', '$filter', 'dialog', 'game', 'player', 'round', 'parcel', 'show'];
